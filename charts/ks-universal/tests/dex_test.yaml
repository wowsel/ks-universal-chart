suite: DexAuthenticator tests
templates:
  - dexauthenticator.yaml
  - ingress.yaml

tests:
  # Global DexAuthenticator tests
  - it: should create a global DexAuthenticator
    set:
      generic:
        dexAuthenticatorGeneral:
          enabled: true
          applicationDomain: global-auth.example.com
          applicationIngressClassName: nginx
          sendAuthorizationHeader: true
          applicationIngressCertificateSecretName: global-tls
          keepUsersLoggedInFor: "48h"
          allowedGroups:
            - everyone
            - admins
          whitelistSourceRanges:
            - 10.0.0.0/8
          nodeSelector:
            kubernetes.io/os: linux
          tolerations:
            - key: "dedicated"
              operator: "Equal"
              value: "auth"
              effect: "NoSchedule"
    asserts:
      - template: dexauthenticator.yaml
        isKind:
          of: DexAuthenticator
      - template: dexauthenticator.yaml
        equal:
          path: metadata.name
          value: global-authenticator
      - template: dexauthenticator.yaml
        equal:
          path: spec.applicationDomain
          value: global-auth.example.com
      - template: dexauthenticator.yaml
        equal:
          path: spec.sendAuthorizationHeader
          value: true
      - template: dexauthenticator.yaml
        equal:
          path: spec.applicationIngressClassName
          value: nginx
      - template: dexauthenticator.yaml
        equal:
          path: spec.keepUsersLoggedInFor
          value: 48h
      - template: dexauthenticator.yaml
        contains:
          path: spec.allowedGroups
          content: everyone
      - template: dexauthenticator.yaml
        contains:
          path: spec.allowedGroups
          content: admins
      - template: dexauthenticator.yaml
        contains:
          path: spec.whitelistSourceRanges
          content: 10.0.0.0/8
      - template: dexauthenticator.yaml
        equal:
          path: spec.nodeSelector["kubernetes.io/os"]
          value: linux
      - template: dexauthenticator.yaml
        contains:
          path: spec.tolerations
          content:
            key: "dedicated"
            operator: "Equal"
            value: "auth"
            effect: "NoSchedule"
  
  - it: should create a certificate when autoCreateCertificate is enabled
    set:
      generic:
        dexAuthenticatorGeneral:
          enabled: true
          applicationDomain: global-auth.example.com
          applicationIngressClassName: nginx
          autoCreateCertificate: true
          certificate:
            clusterIssuer: letsencrypt-prod
    asserts:
      - template: dexauthenticator.yaml
        isKind:
          of: Certificate
        documentIndex: 1
      - template: dexauthenticator.yaml
        equal:
          path: metadata.name
          value: global-authenticator
        documentIndex: 1
      - template: dexauthenticator.yaml
        equal:
          path: spec.issuerRef.kind
          value: ClusterIssuer
        documentIndex: 1
      - template: dexauthenticator.yaml
        equal:
          path: spec.issuerRef.name
          value: letsencrypt-prod
        documentIndex: 1
      - template: dexauthenticator.yaml
        contains:
          path: spec.dnsNames
          content: global-auth.example.com
        documentIndex: 1

  # Ingress with DexAuthenticator tests
  - it: should add global DexAuthenticator annotations to ingress
    set:
      generic:
        ingressesGeneral:
          domain: example.com
          annotations:
            some-annotation: "some-value"
        dexAuthenticatorGeneral:
          enabled: true
          applicationDomain: auth.example.com
          applicationIngressClassName: nginx
      ingresses:
        app-with-dex:
          hosts:
            - host: app.example.com
              paths:
                - path: /
                  pathType: Prefix
                  service: app-service
          dexAuthenticator:
            enabled: true
    asserts:
      - template: ingress.yaml
        isKind:
          of: Ingress
      - template: ingress.yaml
        equal:
          path: metadata.name
          value: app-with-dex
      - template: ingress.yaml
        exists:
          path: metadata.annotations
      - template: ingress.yaml
        equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-signin"]
          value: https://$host/dex-authenticator/sign_in
      - template: ingress.yaml
        equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-response-headers"]
          value: X-Auth-Request-User,X-Auth-Request-Email
      - template: ingress.yaml
        matchRegex:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-url"]
          pattern: https://global-authenticator-dex-authenticator..*svc.cluster.local/dex-authenticator/auth

  # Ingress annotations tests
  - it: should add global DexAuthenticator annotations to ingress with custom annotations
    set:
      generic:
        ingressesGeneral:
          annotations:
            some-base-annotation: "base-value"
        dexAuthenticatorGeneral:
          enabled: true
          applicationDomain: global-auth.example.com
          applicationIngressClassName: nginx
          namespace: auth-system
      ingresses:
        test-ingress:
          annotations:
            custom-annotation: "custom-value"
          hosts:
            - host: app.example.com
              paths:
                - path: /
                  pathType: Prefix
                  service: test-service
                  portName: http
          dexAuthenticator:
            enabled: true
    asserts:
      - template: ingress.yaml
        isKind:
          of: Ingress
      - template: ingress.yaml
        equal:
          path: metadata.name
          value: test-ingress
      - template: ingress.yaml
        equal:
          path: metadata.annotations["custom-annotation"]
          value: custom-value
      - template: ingress.yaml
        equal:
          path: metadata.annotations["some-base-annotation"]
          value: base-value
      - template: ingress.yaml
        equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-signin"]
          value: https://$host/dex-authenticator/sign_in
      - template: ingress.yaml
        equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-response-headers"]
          value: X-Auth-Request-User,X-Auth-Request-Email
      - template: ingress.yaml
        equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-url"]
          value: https://global-authenticator-dex-authenticator.auth-system.svc.cluster.local/dex-authenticator/auth 