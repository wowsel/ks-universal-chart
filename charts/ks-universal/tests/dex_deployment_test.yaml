suite: Deployment with DexAuthenticator
templates:
  - deployment.yaml
tests:
  - it: should add DexAuthenticator annotations to auto-created ingress
    set:
      generic:
        ingressesGeneral:
          domain: example.com
          annotations:
            some-annotation: "some-value"
      deployments:
        app-with-dex:
          autoCreateService: true
          autoCreateIngress: true
          containers:
            main:
              image: nginx
              imageTag: latest
              ports:
                http:
                  containerPort: 80
          ingress:
            hosts:
              - host: app.example.com
                paths:
                  - path: /
                    pathType: Prefix
            dexAuthenticator:
              enabled: true
              applicationIngressCertificateSecretName: ingress-tls
    asserts:
      - isKind:
          of: Ingress
        documentIndex: 1
      - equal:
          path: metadata.name
          value: app-with-dex
        documentIndex: 1
      - exists:
          path: metadata.annotations
        documentIndex: 1
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-signin"]
          value: https://$host/dex-authenticator/sign_in
        documentIndex: 1
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-response-headers"]
          value: X-Auth-Request-User,X-Auth-Request-Email
        documentIndex: 1
      - matchRegex:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-url"]
          pattern: https://app-with-dex-dex-authenticator..*svc.cluster.local/dex-authenticator/auth
        documentIndex: 1 